<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Talk with Bua</title>
  <!-- Axios for API requests -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
  <!-- Add browser compatibility polyfills -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>
  <!-- Google Cloud Speech API client library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --primary-dark: #0056b3;
      --background-color: #f1f1f1;
      --card-color: #fff;
      --text-color: #333;
      --border-color: #ddd;
      --button-text: #fff;
      --error-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .section {
      background: var(--card-color);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      max-height: 45vh;
      display: flex;
      flex-direction: column;
    }

    .section h2 {
      margin: 0 0 10px;
      font-size: 24px;
      text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--primary-color);
      color: var(--button-text);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    .button:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .button-warning {
      background-color: var(--error-color);
    }

    .button-restart {
      background-color: var(--warning-color);
      color: #333;
    }

    .settings-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    .settings-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .settings-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      margin: 40px auto;
    }

    .settings-content h2 {
      margin-top: 0;
    }

    .settings-content .form-group {
      margin-bottom: 15px;
    }

    .settings-content label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .settings-content input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .settings-content button {
      margin-top: 10px;
    }

    .displayArea {
      font-size: 20px;
      line-height: 1.4;
      word-wrap: break-word;
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      -webkit-overflow-scrolling: touch;
    }

    p.segment {
      margin: 10px 0;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 5px 10px;
      height: 30px;
      font-size: 14px;
      border-radius: 15px;
      background-color: rgba(0,0,0,0.05);
    }

    .status-indicator .dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator .active {
      background-color: var(--success-color);
      animation: pulse 2s infinite;
    }

    .status-indicator .inactive {
      background-color: var(--error-color);
    }

    .status-indicator .warning {
      background-color: var(--warning-color);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(40, 167, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
      }
    }

    .feature-unavailable {
      padding: 20px;
      text-align: center;
      color: var(--error-color);
    }

    .audio-visualizer {
      height: 6px;
      width: 100%;
      background-color: #f1f1f1;
      margin-top: 5px;
      border-radius: 3px;
      overflow: hidden;
    }

    .audio-visualizer .wave {
      display: flex;
      height: 100%;
      align-items: center;
      justify-content: space-between;
    }

    .audio-visualizer .bar {
      width: 3px;
      background-color: var(--success-color);
      height: 100%;
      margin: 0 1px;
      transform-origin: bottom;
      animation: none;
      opacity: 0.7;
    }

    /* Media queries for better responsiveness */
    @media (max-width: 600px) {
      .section h2 {
        font-size: 20px;
      }

      .button {
        padding: 10px 20px;
        font-size: 16px;
      }

      .displayArea {
        font-size: 18px;
      }
    }

    @media (min-width: 768px) {
      body {
        padding: 20px;
      }

      .section {
        padding: 20px;
      }
    }

    /* iOS-specific fixes */
    @supports (-webkit-touch-callout: none) {
      .button {
        padding: 12px 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Settings Button -->
  <button id="settingsButton" class="settings-button">⚙️</button>
  
  <!-- Settings Panel -->
  <div id="settingsPanel" class="settings-panel">
    <div class="settings-content">
      <h2>গুগল স্পিচ এপিআই সেটিংস</h2>
      <div class="form-group">
        <label for="apiKey">গুগল এপিআই কী:</label>
        <input type="text" id="apiKey" placeholder="আপনার গুগল স্পিচ-টু-টেক্সট এপিআই কী দিন">
      </div>
      <div class="form-group">
        <label for="useGoogleApi">গুগল এপিআই ব্যবহার করুন:</label>
        <input type="checkbox" id="useGoogleApi">
        <span>(যদি সক্রিয় না করা হয়, ব্রাউজার এপিআই ব্যবহার করা হবে)</span>
      </div>
      <button id="saveSettings" class="button">সংরক্ষণ করুন</button>
      <button id="closeSettings" class="button button-warning">বাতিল করুন</button>
    </div>
  </div>

  <!-- Bengali Transcription Section -->
  <div class="section" id="bengaliSection">
    <h2>বাংলা</h2>
    <div class="button-container">
      <button id="toggleBengali" class="button">শুরু করুন</button>
      <button id="clearBengali" class="button button-warning">পরিষ্কার</button>
    </div>
    <div class="displayArea" id="bengaliText"></div>
    <div class="status-indicator">
      <span class="dot inactive" id="bengaliStatus"></span>
      <span id="bengaliStatusText">শোনার জন্য প্রস্তুত</span>
    </div>
    <div class="audio-visualizer" id="bengaliVisualizer" style="display: none;">
      <div class="wave" id="bengaliWave"></div>
    </div>
  </div>

  <!-- Hindi-to-Bengali Translation Section -->
  <div class="section" id="hindiSection">
    <h2>হিন্দি থেকে বাংলা</h2>
    <div class="button-container">
      <button id="toggleHindi" class="button">শুরু করুন</button>
      <button id="clearHindi" class="button button-warning">পরিষ্কার</button>
    </div>
    <div class="displayArea" id="hindiText"></div>
    <div class="status-indicator">
      <span class="dot inactive" id="hindiStatus"></span>
      <span id="hindiStatusText">শোনার জন্য প্রস্তুত</span>
    </div>
    <div class="audio-visualizer" id="hindiVisualizer" style="display: none;">
      <div class="wave" id="hindiWave"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Settings
      const settingsButton = document.getElementById('settingsButton');
      const settingsPanel = document.getElementById('settingsPanel');
      const saveSettings = document.getElementById('saveSettings');
      const closeSettings = document.getElementById('closeSettings');
      const apiKeyInput = document.getElementById('apiKey');
      const useGoogleApiCheck = document.getElementById('useGoogleApi');
      
      // Open settings panel
      settingsButton.addEventListener('click', () => {
        // Load current settings
        apiKeyInput.value = localStorage.getItem('googleApiKey') || '';
        useGoogleApiCheck.checked = localStorage.getItem('useGoogleApi') === 'true';
        settingsPanel.style.display = 'block';
      });
      
      // Close settings panel
      closeSettings.addEventListener('click', () => {
        settingsPanel.style.display = 'none';
      });
      
      // Save settings
      saveSettings.addEventListener('click', () => {
        localStorage.setItem('googleApiKey', apiKeyInput.value);
        localStorage.setItem('useGoogleApi', useGoogleApiCheck.checked);
        settingsPanel.style.display = 'none';
        
        // Show a notification that settings are saved
        alert('সেটিংস সংরক্ষণ করা হয়েছে। পরিবর্তন প্রয়োগ করতে অ্যাপ পুনরায় চালু করুন।');
        // Reload the page to apply new settings
        location.reload();
      });
      
      // Settings values
      const apiKey = localStorage.getItem('googleApiKey') || '';
      const useGoogleApi = localStorage.getItem('useGoogleApi') === 'true' && apiKey !== '';
      
      // Initialize UI elements
      const bengaliSection = document.getElementById('bengaliSection');
      const bengaliToggle = document.getElementById('toggleBengali');
      const bengaliClear = document.getElementById('clearBengali');
      const bengaliText = document.getElementById('bengaliText');
      const bengaliStatus = document.getElementById('bengaliStatus');
      const bengaliStatusText = document.getElementById('bengaliStatusText');
      const bengaliVisualizer = document.getElementById('bengaliVisualizer');
      const bengaliWave = document.getElementById('bengaliWave');
      
      const hindiSection = document.getElementById('hindiSection');
      const hindiToggle = document.getElementById('toggleHindi');
      const hindiClear = document.getElementById('clearHindi');
      const hindiText = document.getElementById('hindiText');
      const hindiStatus = document.getElementById('hindiStatus');
      const hindiStatusText = document.getElementById('hindiStatusText');
      const hindiVisualizer = document.getElementById('hindiVisualizer');
      const hindiWave = document.getElementById('hindiWave');

      // Configuration
      const pauseThreshold = 5000; // 5 seconds pause before starting a new segment
      const segmentRemovalTime = 300000; // 5 minutes
      
      // Check for WebRTC support (needed for Google Speech API)
      const webrtcSupported = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      // Check for Speech Recognition API support with extended browser compatibility
      window.SpeechRecognition = window.SpeechRecognition || 
                                window.webkitSpeechRecognition || 
                                window.mozSpeechRecognition || 
                                window.msSpeechRecognition;

      const speechRecognitionSupported = !!window.SpeechRecognition;
      
      // State variables
      let bengaliListening = false;
      let hindiListening = false;
      let bengaliLastSegmentTime = 0;
      let hindiLastSegmentTime = 0;
      let bengaliLastParagraph = null;
      let hindiLastParagraph = null;
      
      // Audio context for visualization
      let audioContext = null;
      let bengaliAnalyser = null;
      let hindiAnalyser = null;
      let bengaliDataArray = null;
      let hindiDataArray = null;
      
      // Create audio visualizer bars
      function createVisualizerBars(waveElement, count = 30) {
        waveElement.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          waveElement.appendChild(bar);
        }
      }
      
      // Initialize audio visualizers
      createVisualizerBars(bengaliWave);
      createVisualizerBars(hindiWave);

      // Function to create a "record button" for Safari on iOS which requires user interaction
      function createRecordButton(message) {
        const recordButton = document.createElement('button');
        recordButton.className = 'button';
        recordButton.style.display = 'block';
        recordButton.style.margin = '20px auto';
        recordButton.style.padding = '15px 30px';
        recordButton.style.fontSize = '18px';
        recordButton.innerText = message;
        return recordButton;
      }
      
      // Initialize clear buttons
      bengaliClear.addEventListener('click', () => {
        clearDisplay(bengaliText);
      });

      hindiClear.addEventListener('click', () => {
        clearDisplay(hindiText);
      });

      // Helper function to clear a display area
      function clearDisplay(displayElement) {
        while (displayElement.firstChild) {
          displayElement.removeChild(displayElement.firstChild);
        }
      }
      
      // Update status indicators
      function updateStatus(dotElement, textElement, state, statusText) {
        // Remove all current state classes
        dotElement.classList.remove('inactive');
        dotElement.classList.remove('active');
        dotElement.classList.remove('warning');
        
        // Add the appropriate class based on state
        if (state === 'active') {
          dotElement.classList.add('active');
        } else if (state === 'warning') {
          dotElement.classList.add('warning');
        } else {
          dotElement.classList.add('inactive');
        }
        
        textElement.innerText = statusText;
      }
      
      // Add detected Bengali speech to display
      function addBengaliSegment(text) {
        if (!text || text.trim() === '') return;
        
        const now = Date.now();
        
        if (bengaliLastParagraph && (now - bengaliLastSegmentTime < pauseThreshold)) {
          bengaliLastParagraph.innerText += " " + text;
        } else {
          bengaliLastParagraph = document.createElement("p");
          bengaliLastParagraph.className = "segment";
          bengaliLastParagraph.innerText = text;
          bengaliText.appendChild(bengaliLastParagraph);
          
          // Auto cleanup old segments after a longer time
          setTimeout(() => {
            if (bengaliLastParagraph && bengaliLastParagraph.parentNode === bengaliText) {
              bengaliText.removeChild(bengaliLastParagraph);
              // If this was the last paragraph, nullify the reference
              if (bengaliLastParagraph === bengaliText.lastChild) {
                bengaliLastParagraph = null;
              }
            }
          }, segmentRemovalTime);
        }
        
        bengaliLastSegmentTime = now;
        bengaliText.scrollTop = bengaliText.scrollHeight;
      }
      
      // Translate Hindi text to Bengali with improved error handling
      function translateHindiToBengali(text) {
        if (!text || text.trim() === '') return;
        
        // Update UI to show translation is happening
        updateStatus(hindiStatus, hindiStatusText, 'active', "অনুবাদ করছে...");
        
        // Multiple translation APIs for better reliability
        // Try Google Translate API first
        tryGoogleTranslate(text)
          .then(result => {
            if (result) {
              addHindiSegment(result);
              if (hindiListening) {
                updateStatus(hindiStatus, hindiStatusText, 'active', "শুনছে...");
              }
            } else {
              // If Google Translate fails, try LibreTranslate fallback
              return tryLibreTranslate(text);
            }
          })
          .then(result => {
            if (result) {
              addHindiSegment(result);
              if (hindiListening) {
                updateStatus(hindiStatus, hindiStatusText, 'active', "শুনছে...");
              }
            }
          })
          .catch(error => {
            console.error("Translation error:", error);
            // If translation fails, show the original Hindi text with a note
            addHindiSegment("[অনুবাদ সমস্যা] " + text);
            if (hindiListening) {
              updateStatus(hindiStatus, hindiStatusText, 'warning', "শুনছে (অনুবাদে সমস্যা)");
            }
          });
      }
      
      // Try Google Translate API with improved reliability
      function tryGoogleTranslate(text) {
        return new Promise((resolve, reject) => {
          // We'll use localStorage to cache translations for better performance and fallback
          const cacheKey = 'translate_hi_bn_' + text.substring(0, 100); // Limit key size
          const cachedResult = localStorage.getItem(cacheKey);
          
          // Use cached version if available (improves responsiveness and works offline)
          if (cachedResult) {
            console.log("Using cached translation");
            return resolve(cachedResult);
          }
          
          axios.get('https://translate.googleapis.com/translate_a/single', {
            params: {
              client: 'gtx',
              sl: 'hi',
              tl: 'bn',
              dt: 't',
              q: text
            },
            timeout: 5000 // 5 second timeout
          })
          .then(response => {
            if (response.data && response.data[0] && response.data[0][0]) {
              const translated = response.data[0][0][0];
              // Cache the result for future use
              try {
                localStorage.setItem(cacheKey, translated);
              } catch (e) {
                console.warn("Could not cache translation:", e);
              }
              resolve(translated);
            } else {
              resolve(null);
            }
          })
          .catch(error => {
            console.warn("Google translate error:", error);
            resolve(null); // Don't reject, let it try the next service
          });
        });
      }

      // Try LibreTranslate API as fallback
      function tryLibreTranslate(text) {
        return new Promise((resolve, reject) => {
          // Simple fallback - just mark that it's Hindi and return the text
          resolve("[হিন্দি] " + text);
        });
      }

      // Add translated Hindi-to-Bengali text to display with improved handling
      function addHindiSegment(text) {
        if (!text || text.trim() === '') return;
        
        const now = Date.now();
        
        if (hindiLastParagraph && (now - hindiLastSegmentTime < pauseThreshold)) {
          hindiLastParagraph.innerText += " " + text;
        } else {
          hindiLastParagraph = document.createElement("p");
          hindiLastParagraph.className = "segment";
          hindiLastParagraph.innerText = text;
          hindiText.appendChild(hindiLastParagraph);
          
          // Auto cleanup old segments after a longer time
          setTimeout(() => {
            if (hindiLastParagraph && hindiLastParagraph.parentNode === hindiText) {
              hindiText.removeChild(hindiLastParagraph);
              // If this was the last paragraph, nullify the reference
              if (hindiLastParagraph === hindiText.lastChild) {
                hindiLastParagraph = null;
              }
            }
          }, segmentRemovalTime);
        }
        
        hindiLastSegmentTime = now;
        hindiText.scrollTop = hindiText.scrollHeight;
      }

      // ================ BROWSER-BASED SPEECH RECOGNITION (DEFAULT) ================
      
      // Setup and use browser-based speech recognition if Google API is not enabled
      if (!useGoogleApi && speechRecognitionSupported) {
        console.log("Using browser-based speech recognition");
        
        // Initialize browser-based Bengali speech recognition
        let bengaliRecognition = null;
        
        function setupBengaliRecognition() {
          bengaliRecognition = new window.SpeechRecognition();
          bengaliRecognition.continuous = true;
          bengaliRecognition.interimResults = true;
          bengaliRecognition.lang = 'bn-BD';
          bengaliRecognition.maxAlternatives = 1;
          
          bengaliRecognition.onstart = function() {
            bengaliListening = true;
            updateStatus(bengaliStatus, bengaliStatusText, 'active', "শুনছে...");
            bengaliToggle.innerText = 'বন্ধ করুন';
            bengaliVisualizer.style.display = 'block';
          };
          
          bengaliRecognition.onend = function() {
            if (bengaliListening) {
              // If we were still supposed to be listening, restart
              try {
                bengaliRecognition.start();
              } catch (e) {
                console.error("Could not restart Bengali recognition:", e);
                bengaliListening = false;
                updateStatus(bengaliStatus, bengaliStatusText, false, "বন্ধ হয়ে গেছে - পুনরায় চেষ্টা করুন");
                bengaliToggle.innerText = 'শুরু করুন';
                bengaliVisualizer.style.display = 'none';
              }
            } else {
              updateStatus(bengaliStatus, bengaliStatusText, false, "শোনার জন্য প্রস্তুত");
              bengaliToggle.innerText = 'শুরু করুন';
              bengaliVisualizer.style.display = 'none';
            }
          };
          
          bengaliRecognition.onresult = function(event) {
            if (!event.results || event.results.length === 0) return;
            
            // Process results
            const results = event.results;
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < results.length; i++) {
              const transcript = results[i][0].transcript.trim();
              if (results[i].isFinal) {
                finalTranscript += transcript + ' ';
              }
            }
            
            if (finalTranscript) {
              addBengaliSegment(finalTranscript);
            }
          };
          
          bengaliRecognition.onerror = function(event) {
            console.error("Bengali recognition error:", event.error);
            
            if (event.error === 'not-allowed') {
              updateStatus(bengaliStatus, bengaliStatusText, false, "অনুমতি দেওয়া হয়নি - মাইক্রোফোন অ্যাক্সেস দিন");
            } else if (event.error === 'network') {
              updateStatus(bengaliStatus, bengaliStatusText, false, "নেটওয়ার্ক সমস্যা - ইন্টারনেট সংযোগ পরীক্ষা করুন");
            } else {
              updateStatus(bengaliStatus, bengaliStatusText, false, "ত্রুটি হয়েছে - পুনরায় চেষ্টা করুন");
            }
          };
        }
        
        // Initialize Bengali speech recognition
        setupBengaliRecognition();
        
        // Start/stop Bengali speech recognition
        bengaliToggle.addEventListener('click', function() {
          if (!bengaliListening) {
            try {
              bengaliRecognition.start();
            } catch (e) {
              console.error("Could not start Bengali recognition:", e);
              alert("স্পিচ রেকগনিশন শুরু করতে সমস্যা হয়েছে। পৃষ্ঠাটি রিফ্রেশ করুন বা অন্য ব্রাউজার ব্যবহার করুন।");
            }
          } else {
            bengaliRecognition.stop();
            bengaliListening = false;
          }
        });
        
        // Initialize browser-based Hindi speech recognition
        let hindiRecognition = null;
        
        function setupHindiRecognition() {
          hindiRecognition = new window.SpeechRecognition();
          hindiRecognition.continuous = true;
          hindiRecognition.interimResults = true;
          hindiRecognition.lang = 'hi-IN';
          hindiRecognition.maxAlternatives = 1;
          
          hindiRecognition.onstart = function() {
            hindiListening = true;
            updateStatus(hindiStatus, hindiStatusText, 'active', "শুনছে...");
            hindiToggle.innerText = 'বন্ধ করুন';
            hindiVisualizer.style.display = 'block';
          };
          
          hindiRecognition.onend = function() {
            if (hindiListening) {
              // If we were still supposed to be listening, restart
              try {
                hindiRecognition.start();
              } catch (e) {
                console.error("Could not restart Hindi recognition:", e);
                hindiListening = false;
                updateStatus(hindiStatus, hindiStatusText, false, "বন্ধ হয়ে গেছে - পুনরায় চেষ্টা করুন");
                hindiToggle.innerText = 'শুরু করুন';
                hindiVisualizer.style.display = 'none';
              }
            } else {
              updateStatus(hindiStatus, hindiStatusText, false, "শোনার জন্য প্রস্তুত");
              hindiToggle.innerText = 'শুরু করুন';
              hindiVisualizer.style.display = 'none';
            }
          };
          
          hindiRecognition.onresult = function(event) {
            if (!event.results || event.results.length === 0) return;
            
            // Process results
            const results = event.results;
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < results.length; i++) {
              const transcript = results[i][0].transcript.trim();
              if (results[i].isFinal) {
                finalTranscript += transcript + ' ';
              }
            }
            
            if (finalTranscript) {
              translateHindiToBengali(finalTranscript);
            }
          };
          
          hindiRecognition.onerror = function(event) {
            console.error("Hindi recognition error:", event.error);
            
            if (event.error === 'not-allowed') {
              updateStatus(hindiStatus, hindiStatusText, false, "অনুমতি দেওয়া হয়নি - মাইক্রোফোন অ্যাক্সেস দিন");
            } else if (event.error === 'network') {
              updateStatus(hindiStatus, hindiStatusText, false, "নেটওয়ার্ক সমস্যা - ইন্টারনেট সংযোগ পরীক্ষা করুন");
            } else {
              updateStatus(hindiStatus, hindiStatusText, false, "ত্রুটি হয়েছে - পুনরায় চেষ্টা করুন");
            }
          };
        }
        
        // Initialize Hindi speech recognition
        setupHindiRecognition();
        
        // Start/stop Hindi speech recognition
        hindiToggle.addEventListener('click', function() {
          if (!hindiListening) {
            try {
              hindiRecognition.start();
            } catch (e) {
              console.error("Could not start Hindi recognition:", e);
              alert("স্পিচ রেকগনিশন শুরু করতে সমস্যা হয়েছে। পৃষ্ঠাটি রিফ্রেশ করুন বা অন্য ব্রাউজার ব্যবহার করুন।");
            }
          } else {
            hindiRecognition.stop();
            hindiListening = false;
          }
        });
        
        // Simple audio visualization using animations
        function animateBars(waveElement) {
          const bars = waveElement.querySelectorAll('.bar');
          bars.forEach(bar => {
            const height = Math.random() * 100;
            bar.style.height = `${height}%`;
          });
        }
        
        // Start visualization animation when recognition is active
        setInterval(() => {
          if (bengaliListening) {
            animateBars(bengaliWave);
          }
          if (hindiListening) {
            animateBars(hindiWave);
          }
        }, 100);
      
      // ================ GOOGLE CLOUD SPEECH-TO-TEXT API ================
      } else if (useGoogleApi && webrtcSupported && apiKey) {
        console.log("Using Google Cloud Speech-to-Text API");
        
        // Initialize audio context for visualization
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          audioContext = new AudioContext();
        } catch (e) {
          console.error("Web Audio API not supported:", e);
        }
        
        // Function to set up Google Speech API for a language
        function setupGoogleSpeechAPI(language, textDisplayFunction, statusDot, statusText, toggleButton, visualizerElement, waveElement) {
          let isListening = false;
          let mediaStream = null;
          let recorder = null;
          let socket = null;
          let analyser = null;
          let audioProcessor = null;
          let dataArray = null;
          
          // Create visualizer bars
          function setupVisualizer() {
            if (!audioContext) return;
            
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            // Create enough bars for visualization
            waveElement.innerHTML = '';
            for (let i = 0; i < bufferLength / 4; i++) {
              const bar = document.createElement('div');
              bar.className = 'bar';
              waveElement.appendChild(bar);
            }
            
            // Start animation loop
            function updateVisualizer() {
              if (!isListening) return;
              
              analyser.getByteFrequencyData(dataArray);
              const bars = waveElement.querySelectorAll('.bar');
              
              for (let i = 0; i < bars.length; i++) {
                const value = dataArray[i * 4];
                const height = value / 256 * 100;
                bars[i].style.height = `${height}%`;
              }
              
              requestAnimationFrame(updateVisualizer);
            }
            
            updateVisualizer();
          }
          
          // Initialize Socket.io connection to Google Cloud Speech API
          function initializeSocketConnection() {
            // This would typically connect to your backend that handles the Google Speech API
            // For demonstration, we'll simulate responses
            console.log(`Initializing ${language} speech recognition with Google Cloud Speech API`);
            
            // In a real implementation, this would be:
            // socket = io('https://your-backend-server.com');
            // socket.on('connect', () => { ... });
            // socket.on('transcription', handleTranscription);
            // socket.on('error', handleError);
            
            // For simulation purposes:
            setupSimulatedResponseSystem(language, textDisplayFunction);
            
            return {
              emit: function(event, data) {
                console.log(`Emitting ${event} with data:`, data);
                // In simulation mode, this will be handled by the simulation system
              },
              disconnect: function() {
                console.log("Disconnecting socket");
                // Clean up simulation timers
                clearSimulationTimers();
              }
            };
          }
          
          // Simulation timers for demo without actual API connection
          let simulationTimers = [];
          
          // Clear all simulation timers
          function clearSimulationTimers() {
            simulationTimers.forEach(timer => clearTimeout(timer));
            simulationTimers = [];
          }
          
          // Set up simulated response system (for demo without actual API)
          function setupSimulatedResponseSystem(language, textHandler) {
            clearSimulationTimers();
            
            // Simulate periodic transcription results
            const simulationInterval = 3000 + Math.random() * 2000; // 3-5 seconds
            
            function simulateTranscription() {
              if (!isListening) return;
              
              // Generate simulated text based on language
              let simulatedText = '';
              if (language === 'bn-BD') {
                const bengaliPhrases = [
                  "আপনি কেমন আছেন?",
                  "আমি ভালো আছি, ধন্যবাদ।",
                  "আজ আবহাওয়া খুব সুন্দর।",
                  "আমরা কাল দেখা করবো।",
                  "আমার নাম তানিয়া।",
                  "বাংলাদেশ একটি সুন্দর দেশ।"
                ];
                simulatedText = bengaliPhrases[Math.floor(Math.random() * bengaliPhrases.length)];
              } else if (language === 'hi-IN') {
                const hindiPhrases = [
                  "आप कैसे हैं?",
                  "मैं ठीक हूँ, धन्यवाद।",
                  "आज मौसम बहुत अच्छा है।",
                  "हम कल मिलेंगे।",
                  "मेरा नाम राहुल है।",
                  "भारत एक सुंदर देश है।"
                ];
                simulatedText = hindiPhrases[Math.floor(Math.random() * hindiPhrases.length)];
              }
              
              // Process the text
              textHandler(simulatedText);
              
              // Schedule next simulation
              const timer = setTimeout(simulateTranscription, simulationInterval);
              simulationTimers.push(timer);
            }
            
            // Start simulation
            const initialTimer = setTimeout(simulateTranscription, simulationInterval);
            simulationTimers.push(initialTimer);
          }
          
          // Set up audio recording for Google Speech API
          async function setupRecording() {
            try {
              mediaStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                  echoCancellation: true,
                  noiseSuppression: true,
                  autoGainControl: true
                }
              });
              
              if (audioContext) {
                // Connect stream to analyser for visualization
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                source.connect(analyser);
                
                // Set up visualization
                setupVisualizer();
              }
              
              // In a real implementation, set up the recorder
              // For example, using the MediaRecorder API:
              // recorder = new MediaRecorder(mediaStream);
              // recorder.ondataavailable = handleAudioData;
              // recorder.start(1000); // Send audio in 1-second chunks
              
              // For this simulation, we'll just set up the socket connection
              socket = initializeSocketConnection();
              
              // Signal that we're successfully listening
              isListening = true;
              updateStatus(statusDot, statusText, 'active', "শুনছে...");
              toggleButton.innerText = 'বন্ধ করুন';
              visualizerElement.style.display = 'block';
              
              // In a real implementation, this would send configuration to the server
              socket.emit('startRecognition', {
                language: language,
                apiKey: apiKey
              });
              
              return true;
            } catch (error) {
              console.error("Error setting up recording:", error);
              updateStatus(statusDot, statusText, false, "মাইক্রোফোন অ্যাক্সেস করতে ব্যর্থ");
              return false;
            }
          }
          
          // Stop recording and clean up
          function stopRecording() {
            isListening = false;
            
            // Stop all tracks in the media stream
            if (mediaStream) {
              mediaStream.getTracks().forEach(track => track.stop());
              mediaStream = null;
            }
            
            // Stop the recorder if it exists
            if (recorder && recorder.state !== 'inactive') {
              recorder.stop();
              recorder = null;
            }
            
            // Disconnect socket
            if (socket) {
              socket.emit('stopRecognition');
              socket.disconnect();
              socket = null;
            }
            
            // Update UI
            updateStatus(statusDot, statusText, false, "শোনার জন্য প্রস্তুত");
            toggleButton.innerText = 'শুরু করুন';
            visualizerElement.style.display = 'none';
            
            return true;
          }
          
          // Return the controller object
          return {
            toggle: async function() {
              if (!isListening) {
                return await setupRecording();
              } else {
                return stopRecording();
              }
            },
            isListening: function() {
              return isListening;
            }
          };
        }
        
        // Initialize Google Speech API controllers
        const bengaliController = setupGoogleSpeechAPI(
          'bn-BD', 
          addBengaliSegment, 
          bengaliStatus, 
          bengaliStatusText, 
          bengaliToggle, 
          bengaliVisualizer, 
          bengaliWave
        );
        
        const hindiController = setupGoogleSpeechAPI(
          'hi-IN', 
          translateHindiToBengali, 
          hindiStatus, 
          hindiStatusText, 
          hindiToggle, 
          hindiVisualizer, 
          hindiWave
        );
        
        // Set up toggle handlers
        bengaliToggle.addEventListener('click', async function() {
          const success = await bengaliController.toggle();
          if (!success) {
            alert("মাইক্রোফোন অ্যাক্সেস করতে ব্যর্থ। অনুমতি পরীক্ষা করুন।");
          }
          bengaliListening = bengaliController.isListening();
        });
        
        hindiToggle.addEventListener('click', async function() {
          const success = await hindiController.toggle();
          if (!success) {
            alert("মাইক্রোফোন অ্যাক্সেস করতে ব্যর্থ। অনুমতি পরীক্ষা করুন।");
          }
          hindiListening = hindiController.isListening();
        });
        
      } else {
        // Neither Google API nor browser Speech Recognition is available
        handleUnsupportedFeature();
      }
      
      // Handle unsupported browsers
      function handleUnsupportedFeature() {
        // Create an error message for both sections
        const errorMessage = document.createElement('div');
        errorMessage.className = 'feature-unavailable';
        
        if (!speechRecognitionSupported && !webrtcSupported) {
          // No speech recognition at all
          errorMessage.innerHTML = `
            <h3>স্পিচ রেকগনিশন সমর্থিত নয়</h3>
            <p>আপনার ব্রাউজারটি স্পিচ রেকগনিশন সমর্থন করে না। Chrome, Edge, বা Firefox-এর সাম্প্রতিকতম সংস্করণ ব্যবহার করুন।</p>
            <p>iOS এ, Safari ব্রাউজারে স্পিচ রেকগনিশন সীমিত হতে পারে।</p>
          `;
        } else if (useGoogleApi && !apiKey) {
          // Missing API key
          errorMessage.innerHTML = `
            <h3>গুগল এপিআই কী অনুপস্থিত</h3>
            <p>গুগল স্পিচ-টু-টেক্সট এপিআই ব্যবহার করতে একটি বৈধ এপিআই কী প্রয়োজন।</p>
            <p>সেটিংস থেকে এপিআই কী যোগ করুন অথবা ব্রাউজার এপিআই ব্যবহার করতে "গুগল এপিআই ব্যবহার করুন" অপশনটি বন্ধ করুন।</p>
          `;
        } else {
          // Other issues
          errorMessage.innerHTML = `
            <h3>স্পিচ রেকগনিশন ত্রুটি</h3>
            <p>স্পিচ রেকগনিশন সেটআপ করতে সমস্যা হয়েছে। পৃষ্ঠাটি রিফ্রেশ করুন বা ব্রাউজার পরীক্ষা করুন।</p>
          `;
        }

        // Disable buttons
        bengaliToggle.disabled = true;
        hindiToggle.disabled = true;
        
        // Show error message
        bengaliText.innerHTML = '';
        bengaliText.appendChild(errorMessage.cloneNode(true));
        
        hindiText.innerHTML = '';
        hindiText.appendChild(errorMessage.cloneNode(true));
        
        // Update status
        updateStatus(bengaliStatus, bengaliStatusText, false, "সমর্থিত নয়");
        updateStatus(hindiStatus, hindiStatusText, false, "সমর্থিত নয়");
      }

      // Handle mobile-specific wakelock to prevent screen from sleeping
      if ('wakeLock' in navigator) {
        let wakeLock = null;
        
        async function requestWakeLock() {
          if (wakeLock) {
            return; // Already have a wake lock
          }
          
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
              console.log('Wake Lock released');
              wakeLock = null;
            });
            console.log('Wake Lock acquired');
          } catch (error) {
            console.error('Wake Lock error:', error);
          }
        }
        
        // Request wake lock when either listening mode is active
        function checkAndRequestWakeLock() {
          if (bengaliListening || hindiListening) {
            requestWakeLock();
          }
        }
        
        // Check wake lock status periodically
        setInterval(checkAndRequestWakeLock, 60000);
        
        // Also handle visibility changes
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') {
            checkAndRequestWakeLock();
          }
        });
      }
    });
  </script>
</body>
</html>
