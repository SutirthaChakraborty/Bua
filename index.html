<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Talk with Bua</title>
  <!-- Axios for API requests -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
  <!-- Add browser compatibility polyfills -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --primary-dark: #0056b3;
      --background-color: #f1f1f1;
      --card-color: #fff;
      --text-color: #333;
      --border-color: #ddd;
      --button-text: #fff;
      --error-color: #dc3545;
      --success-color: #28a745;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .section {
      background: var(--card-color);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      max-height: 45vh;
      display: flex;
      flex-direction: column;
    }

    .section h2 {
      margin: 0 0 10px;
      font-size: 24px;
      text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--primary-color);
      color: var(--button-text);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
    }

    .button:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .button-warning {
      background-color: var(--error-color);
    }

    .displayArea {
      font-size: 20px;
      line-height: 1.4;
      word-wrap: break-word;
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      -webkit-overflow-scrolling: touch;
    }

    p.segment {
      margin: 10px 0;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 5px;
      height: 20px;
      font-size: 14px;
    }

    .status-indicator .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-indicator .active {
      background-color: var(--success-color);
    }

    .status-indicator .inactive {
      background-color: var(--error-color);
    }

    .feature-unavailable {
      padding: 20px;
      text-align: center;
      color: var(--error-color);
    }

    /* Media queries for better responsiveness */
    @media (max-width: 600px) {
      .section h2 {
        font-size: 20px;
      }

      .button {
        padding: 10px 20px;
        font-size: 16px;
      }

      .displayArea {
        font-size: 18px;
      }
    }

    @media (min-width: 768px) {
      body {
        padding: 20px;
      }

      .section {
        padding: 20px;
      }
    }

    /* iOS-specific fixes */
    @supports (-webkit-touch-callout: none) {
      .button {
        padding: 12px 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Bengali Transcription Section -->
  <div class="section" id="bengaliSection">
    <h2>বাংলা</h2>
    <div class="button-container">
      <button id="toggleBengali" class="button">শুরু করুন</button>
      <button id="clearBengali" class="button button-warning">পরিষ্কার</button>
    </div>
    <div class="displayArea" id="bengaliText"></div>
    <div class="status-indicator">
      <span class="dot inactive" id="bengaliStatus"></span>
      <span id="bengaliStatusText">শোনার জন্য প্রস্তুত</span>
    </div>
  </div>

  <!-- Hindi-to-Bengali Translation Section -->
  <div class="section" id="hindiSection">
    <h2>হিন্দি থেকে বাংলা</h2>
    <div class="button-container">
      <button id="toggleHindi" class="button">শুরু করুন</button>
      <button id="clearHindi" class="button button-warning">পরিষ্কার</button>
    </div>
    <div class="displayArea" id="hindiText"></div>
    <div class="status-indicator">
      <span class="dot inactive" id="hindiStatus"></span>
      <span id="hindiStatusText">শোনার জন্য প্রস্তুত</span>
    </div>
  </div>

  <script>
    // Feature detection and initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Check for Speech Recognition API support with extended browser compatibility
      window.SpeechRecognition = window.SpeechRecognition || 
                                window.webkitSpeechRecognition || 
                                window.mozSpeechRecognition || 
                                window.msSpeechRecognition;

      const speechRecognitionSupported = !!window.SpeechRecognition;
      
      // Handling for iOS Safari which may have partial support
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      // Initialize UI elements
      const bengaliSection = document.getElementById('bengaliSection');
      const bengaliToggle = document.getElementById('toggleBengali');
      const bengaliClear = document.getElementById('clearBengali');
      const bengaliText = document.getElementById('bengaliText');
      const bengaliStatus = document.getElementById('bengaliStatus');
      const bengaliStatusText = document.getElementById('bengaliStatusText');
      
      const hindiSection = document.getElementById('hindiSection');
      const hindiToggle = document.getElementById('toggleHindi');
      const hindiClear = document.getElementById('clearHindi');
      const hindiText = document.getElementById('hindiText');
      const hindiStatus = document.getElementById('hindiStatus');
      const hindiStatusText = document.getElementById('hindiStatusText');

      // Configuration
      const pauseThreshold = 5000; // 5 seconds pause before starting a new segment
      const segmentRemovalTime = 60000; // 1 minute

      let bengaliRecognition = null;
      let hindiRecognition = null;
      let bengaliListening = false;
      let hindiListening = false;
      let bengaliLastSegmentTime = 0;
      let hindiLastSegmentTime = 0;
      let bengaliLastParagraph = null;
      let hindiLastParagraph = null;
      
      // Setup and configure speech recognition if supported
      if (speechRecognitionSupported) {
        setupBengaliRecognition();
        setupHindiRecognition();
      } else {
        handleUnsupportedFeature();
      }

      // Initialize clear buttons
      bengaliClear.addEventListener('click', () => {
        clearDisplay(bengaliText);
      });

      hindiClear.addEventListener('click', () => {
        clearDisplay(hindiText);
      });

      // Helper function to clear a display area
      function clearDisplay(displayElement) {
        while (displayElement.firstChild) {
          displayElement.removeChild(displayElement.firstChild);
        }
      }

      // Setup Bengali speech recognition
      function setupBengaliRecognition() {
        if (!speechRecognitionSupported) return;

        bengaliRecognition = new window.SpeechRecognition();
        bengaliRecognition.continuous = true;
        bengaliRecognition.interimResults = false;
        bengaliRecognition.lang = 'bn-BD';
        bengaliRecognition.maxAlternatives = 1;

        bengaliToggle.addEventListener('click', toggleBengaliRecognition);
        
        bengaliRecognition.onstart = function() {
          bengaliListening = true;
          updateStatus(bengaliStatus, bengaliStatusText, true, "শুনছে...");
          bengaliToggle.innerText = 'বন্ধ করুন';
        };

        bengaliRecognition.onend = function() {
          if (bengaliListening) {
            // Try to restart if auto-stopped and still in listening mode
            try {
              bengaliRecognition.start();
            } catch (e) {
              console.error("Could not restart Bengali recognition:", e);
              bengaliListening = false;
              updateStatus(bengaliStatus, bengaliStatusText, false, "বন্ধ হয়ে গেছে - পুনরায় চেষ্টা করুন");
              bengaliToggle.innerText = 'শুরু করুন';
            }
          } else {
            updateStatus(bengaliStatus, bengaliStatusText, false, "শোনার জন্য প্রস্তুত");
            bengaliToggle.innerText = 'শুরু করুন';
          }
        };

        bengaliRecognition.onresult = function(event) {
          if (!event.results || event.results.length === 0) return;
          
          const last = event.results.length - 1;
          const transcript = event.results[last][0].transcript.trim();
          if (transcript) {
            addBengaliSegment(transcript);
          }
        };

        bengaliRecognition.onerror = function(event) {
          console.error("Bengali recognition error:", event.error);
          
          // Handle specific errors
          if (event.error === 'not-allowed') {
            updateStatus(bengaliStatus, bengaliStatusText, false, "অনুমতি দেওয়া হয়নি - মাইক্রোফোন অ্যাক্সেস দিন");
          } else if (event.error === 'network') {
            updateStatus(bengaliStatus, bengaliStatusText, false, "নেটওয়ার্ক সমস্যা - ইন্টারনেট সংযোগ পরীক্ষা করুন");
          } else {
            updateStatus(bengaliStatus, bengaliStatusText, false, "ত্রুটি হয়েছে - পুনরায় চেষ্টা করুন");
          }
          
          // Reset state
          bengaliListening = false;
          bengaliToggle.innerText = 'শুরু করুন';
        };
      }

      function toggleBengaliRecognition() {
        if (!bengaliRecognition) return;

        if (!bengaliListening) {
          try {
            bengaliRecognition.start();
          } catch (e) {
            console.error("Could not start Bengali recognition:", e);
            alert("স্পিচ রেকগনিশন শুরু করতে সমস্যা হয়েছে। পৃষ্ঠাটি রিফ্রেশ করুন বা অন্য ব্রাউজার ব্যবহার করুন।");
          }
        } else {
          bengaliRecognition.stop();
          bengaliListening = false;
        }
      }

      // Add detected Bengali speech to display
      function addBengaliSegment(text) {
        const now = Date.now();
        
        if (bengaliLastParagraph && (now - bengaliLastSegmentTime < pauseThreshold)) {
          bengaliLastParagraph.innerText += " " + text;
        } else {
          bengaliLastParagraph = document.createElement("p");
          bengaliLastParagraph.className = "segment";
          bengaliLastParagraph.innerText = text;
          bengaliText.appendChild(bengaliLastParagraph);
          
          // Auto cleanup old segments
          setTimeout(() => {
            if (bengaliLastParagraph && bengaliLastParagraph.parentNode === bengaliText) {
              bengaliText.removeChild(bengaliLastParagraph);
              // If this was the last paragraph, nullify the reference
              if (bengaliLastParagraph === bengaliText.lastChild) {
                bengaliLastParagraph = null;
              }
            }
          }, segmentRemovalTime);
        }
        
        bengaliLastSegmentTime = now;
        bengaliText.scrollTop = bengaliText.scrollHeight;
      }

      // Setup Hindi speech recognition with Bengali translation
      function setupHindiRecognition() {
        if (!speechRecognitionSupported) return;

        hindiRecognition = new window.SpeechRecognition();
        hindiRecognition.continuous = true;
        hindiRecognition.interimResults = false;
        hindiRecognition.lang = 'hi-IN';
        hindiRecognition.maxAlternatives = 1;

        hindiToggle.addEventListener('click', toggleHindiRecognition);
        
        hindiRecognition.onstart = function() {
          hindiListening = true;
          updateStatus(hindiStatus, hindiStatusText, true, "শুনছে...");
          hindiToggle.innerText = 'বন্ধ করুন';
        };

        hindiRecognition.onend = function() {
          if (hindiListening) {
            // Try to restart if auto-stopped and still in listening mode
            try {
              hindiRecognition.start();
            } catch (e) {
              console.error("Could not restart Hindi recognition:", e);
              hindiListening = false;
              updateStatus(hindiStatus, hindiStatusText, false, "বন্ধ হয়ে গেছে - পুনরায় চেষ্টা করুন");
              hindiToggle.innerText = 'শুরু করুন';
            }
          } else {
            updateStatus(hindiStatus, hindiStatusText, false, "শোনার জন্য প্রস্তুত");
            hindiToggle.innerText = 'শুরু করুন';
          }
        };

        hindiRecognition.onresult = function(event) {
          if (!event.results || event.results.length === 0) return;
          
          const last = event.results.length - 1;
          const transcript = event.results[last][0].transcript.trim();
          if (transcript) {
            translateHindiToBengali(transcript);
          }
        };

        hindiRecognition.onerror = function(event) {
          console.error("Hindi recognition error:", event.error);
          
          // Handle specific errors
          if (event.error === 'not-allowed') {
            updateStatus(hindiStatus, hindiStatusText, false, "অনুমতি দেওয়া হয়নি - মাইক্রোফোন অ্যাক্সেস দিন");
          } else if (event.error === 'network') {
            updateStatus(hindiStatus, hindiStatusText, false, "নেটওয়ার্ক সমস্যা - ইন্টারনেট সংযোগ পরীক্ষা করুন");
          } else {
            updateStatus(hindiStatus, hindiStatusText, false, "ত্রুটি হয়েছে - পুনরায় চেষ্টা করুন");
          }
          
          // Reset state
          hindiListening = false;
          hindiToggle.innerText = 'শুরু করুন';
        };
      }

      function toggleHindiRecognition() {
        if (!hindiRecognition) return;

        if (!hindiListening) {
          try {
            hindiRecognition.start();
          } catch (e) {
            console.error("Could not start Hindi recognition:", e);
            alert("স্পিচ রেকগনিশন শুরু করতে সমস্যা হয়েছে। পৃষ্ঠাটি রিফ্রেশ করুন বা অন্য ব্রাউজার ব্যবহার করুন।");
          }
        } else {
          hindiRecognition.stop();
          hindiListening = false;
        }
      }

      // Translate Hindi text to Bengali and display
      function translateHindiToBengali(text) {
        // Update UI to show translation is happening
        updateStatus(hindiStatus, hindiStatusText, true, "অনুবাদ করছে...");
        
        // Multiple translation APIs for better reliability
        // Try Google Translate API first
        tryGoogleTranslate(text)
          .then(result => {
            if (result) {
              addHindiSegment(result);
              updateStatus(hindiStatus, hindiStatusText, true, "শুনছে...");
            } else {
              // If Google Translate fails, try LibreTranslate fallback
              return tryLibreTranslate(text);
            }
          })
          .then(result => {
            if (result) {
              addHindiSegment(result);
              updateStatus(hindiStatus, hindiStatusText, true, "শুনছে...");
            }
          })
          .catch(error => {
            console.error("Translation error:", error);
            // If translation fails, show the original Hindi text with a note
            addHindiSegment("[অনুবাদ সমস্যা] " + text);
            updateStatus(hindiStatus, hindiStatusText, true, "শুনছে (অনুবাদে সমস্যা)");
          });
      }

      // Try Google Translate API
      function tryGoogleTranslate(text) {
        return new Promise((resolve, reject) => {
          axios.get('https://translate.googleapis.com/translate_a/single', {
            params: {
              client: 'gtx',
              sl: 'hi',
              tl: 'bn',
              dt: 't',
              q: text
            },
            timeout: 5000 // 5 second timeout
          })
          .then(response => {
            if (response.data && response.data[0] && response.data[0][0]) {
              resolve(response.data[0][0][0]);
            } else {
              resolve(null);
            }
          })
          .catch(error => {
            console.warn("Google translate error:", error);
            resolve(null); // Don't reject, let it try the next service
          });
        });
      }

      // Try LibreTranslate API as fallback (if you have a LibreTranslate instance)
      function tryLibreTranslate(text) {
        return new Promise((resolve, reject) => {
          // Fallback: If you don't have a LibreTranslate instance,
          // you can just return the original text
          resolve("[हिंदी] " + text);
          
          // If you have a LibreTranslate instance, use this:
          /*
          axios.post('https://your-libretranslate-instance.com/translate', {
            q: text,
            source: 'hi',
            target: 'bn',
            format: 'text'
          }, {
            timeout: 5000
          })
          .then(response => {
            if (response.data && response.data.translatedText) {
              resolve(response.data.translatedText);
            } else {
              resolve("[हिंदी] " + text);
            }
          })
          .catch(error => {
            console.warn("LibreTranslate error:", error);
            resolve("[हिंदी] " + text);
          });
          */
        });
      }

      // Add translated Hindi-to-Bengali text to display
      function addHindiSegment(text) {
        const now = Date.now();
        
        if (hindiLastParagraph && (now - hindiLastSegmentTime < pauseThreshold)) {
          hindiLastParagraph.innerText += " " + text;
        } else {
          hindiLastParagraph = document.createElement("p");
          hindiLastParagraph.className = "segment";
          hindiLastParagraph.innerText = text;
          hindiText.appendChild(hindiLastParagraph);
          
          // Auto cleanup old segments
          setTimeout(() => {
            if (hindiLastParagraph && hindiLastParagraph.parentNode === hindiText) {
              hindiText.removeChild(hindiLastParagraph);
              // If this was the last paragraph, nullify the reference
              if (hindiLastParagraph === hindiText.lastChild) {
                hindiLastParagraph = null;
              }
            }
          }, segmentRemovalTime);
        }
        
        hindiLastSegmentTime = now;
        hindiText.scrollTop = hindiText.scrollHeight;
      }

      // Update status indicators
      function updateStatus(dotElement, textElement, isActive, statusText) {
        if (isActive) {
          dotElement.classList.remove('inactive');
          dotElement.classList.add('active');
        } else {
          dotElement.classList.remove('active');
          dotElement.classList.add('inactive');
        }
        textElement.innerText = statusText;
      }

      // Handle unsupported browsers
      function handleUnsupportedFeature() {
        // Create an error message for both sections
        const errorMessage = document.createElement('div');
        errorMessage.className = 'feature-unavailable';
        errorMessage.innerHTML = `
          <h3>স্পিচ রেকগনিশন সমর্থিত নয়</h3>
          <p>আপনার ব্রাউজারটি স্পিচ রেকগনিশন সমর্থন করে না। Chrome, Edge, বা Firefox-এর সাম্প্রতিকতম সংস্করণ ব্যবহার করুন।</p>
          <p>iOS এ, Safari ব্রাউজারে স্পিচ রেকগনিশন সীমিত হতে পারে।</p>
        `;

        // Disable buttons
        bengaliToggle.disabled = true;
        hindiToggle.disabled = true;
        
        // Show error message
        bengaliText.innerHTML = '';
        bengaliText.appendChild(errorMessage.cloneNode(true));
        
        hindiText.innerHTML = '';
        hindiText.appendChild(errorMessage.cloneNode(true));
        
        // Update status
        updateStatus(bengaliStatus, bengaliStatusText, false, "সমর্থিত নয়");
        updateStatus(hindiStatus, hindiStatusText, false, "সমর্থিত নয়");
      }

      // Detect and handle page visibility changes to conserve battery
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          // Page is hidden, pause recognition to save battery
          if (bengaliListening && bengaliRecognition) {
            bengaliRecognition.stop();
            bengaliListening = false;
          }
          if (hindiListening && hindiRecognition) {
            hindiRecognition.stop();
            hindiListening = false;
          }
        } else {
          // Page is visible again, don't automatically restart to respect user choice
        }
      });

      // Handle mobile-specific wakelock to prevent screen from sleeping
      if ('wakeLock' in navigator) {
        let wakeLock = null;
        
        async function requestWakeLock() {
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
              console.log('Wake Lock released');
            });
            console.log('Wake Lock acquired');
          } catch (error) {
            console.error('Wake Lock error:', error);
          }
        }
        
        // Request wake lock when either recognition is active
        bengaliToggle.addEventListener('click', () => {
          if (bengaliListening) requestWakeLock();
        });
        
        hindiToggle.addEventListener('click', () => {
          if (hindiListening) requestWakeLock();
        });
        
        // Release wake lock when page is hidden
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden' && wakeLock) {
            wakeLock.release().then(() => {
              wakeLock = null;
            });
          } else if (document.visibilityState === 'visible' && 
                     (bengaliListening || hindiListening)) {
            requestWakeLock();
          }
        });
      }

      // Initialize iOS audio session - this can help with iOS compatibility
      function initIOSAudio() {
        if (isIOS) {
          // Create a silent audio context to initialize audio session
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();
            
            // Create and play a short, silent buffer
            const buffer = audioContext.createBuffer(1, 1, 22050);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            
            // Use user interaction to start audio
            document.body.addEventListener('touchstart', function initAudio() {
              source.start(0);
              document.body.removeEventListener('touchstart', initAudio);
            }, false);
          } catch (e) {
            console.warn("Could not initialize iOS audio:", e);
          }
        }
      }

      // Call iOS audio initialization
      initIOSAudio();
    });
  </script>
</body>
</html>
